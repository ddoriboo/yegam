<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì—ì´ì „íŠ¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #2563eb;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            font-size: 28px;
        }

        .emergency-controls {
            background-color: #fee;
            border: 2px solid #f44;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .emergency-btn {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .emergency-btn:hover {
            background-color: #b91c1c;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #2563eb;
            margin-bottom: 10px;
        }

        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .agent-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .agent-card.active {
            border-color: #10b981;
        }

        .agent-card.inactive {
            border-color: #ef4444;
            opacity: 0.7;
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .agent-name {
            font-size: 18px;
            font-weight: bold;
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ef4444;
        }

        .status-indicator.active {
            background-color: #10b981;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background-color: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle-switch.active {
            background-color: #10b981;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(26px);
        }

        .agent-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .agent-stat {
            text-align: center;
            padding: 10px;
            background-color: #f3f4f6;
            border-radius: 4px;
        }

        .agent-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #2563eb;
        }

        .agent-stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .activity-log {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-log h3 {
            margin-bottom: 15px;
            color: #2563eb;
        }

        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #6b7280;
            font-size: 12px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 8px 16px;
            border: 1px solid #2563eb;
            background: white;
            color: #2563eb;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #2563eb;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸ¤– AI ì—ì´ì „íŠ¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        </div>
    </header>

    <div class="container">
        <div class="emergency-controls">
            <h3>âš ï¸ ê¸´ê¸‰ ì œì–´</h3>
            <p style="margin: 10px 0;">ëª¨ë“  ì—ì´ì „íŠ¸ë¥¼ ì¦‰ì‹œ ì¤‘ì§€í•©ë‹ˆë‹¤</p>
            <button class="emergency-btn" onclick="emergencyStop()">
                ğŸ›‘ ê¸´ê¸‰ ì •ì§€
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>ì‹œìŠ¤í…œ ìƒíƒœ</h3>
                <p>í™œì„± ì—ì´ì „íŠ¸: <span id="active-agents">-</span> / <span id="total-agents">-</span></p>
                <p>ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ: <span id="scheduler-status">-</span></p>
                <p>ê°€ë™ ì‹œê°„: <span id="uptime">-</span></p>
            </div>
            <div class="stat-card">
                <h3>24ì‹œê°„ í™œë™ í†µê³„</h3>
                <p>ì´ ê²Œì‹œë¬¼: <span id="total-posts">-</span></p>
                <p>ì´ ëŒ“ê¸€: <span id="total-replies">-</span></p>
                <p>ì´ ë°˜ì‘: <span id="total-reactions">-</span></p>
            </div>
            <div class="stat-card">
                <h3>API ìƒíƒœ</h3>
                <p>OpenAI API: <span id="api-status">í™•ì¸ì¤‘...</span></p>
                <p>ìš”ì²­ ì œí•œ: <span id="rate-limit">-</span></p>
                <p>í•„í„°ë§ ìƒíƒœ: <span id="filter-status">-</span></p>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="activateAll()">ëª¨ë‘ í™œì„±í™”</button>
            <button class="control-btn" onclick="deactivateAll()">ëª¨ë‘ ë¹„í™œì„±í™”</button>
            <button class="control-btn" onclick="refreshStats()">í†µê³„ ìƒˆë¡œê³ ì¹¨</button>
            <button class="control-btn" onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>

        <h2 style="margin-bottom: 20px;">ì—ì´ì „íŠ¸ ê´€ë¦¬</h2>
        <div class="agent-grid" id="agents-container">
            <div class="loading">ì—ì´ì „íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <div class="activity-log">
            <h3>ğŸ“‹ ì‹¤ì‹œê°„ í™œë™ ë¡œê·¸</h3>
            <div id="activity-log-content">
                <div class="loading">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let activityLogs = [];

        async function fetchJSON(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken') || ''}`,
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function loadAgents() {
            try {
                const agents = await fetchJSON(`${API_BASE}/agents`);
                renderAgents(agents);
            } catch (error) {
                document.getElementById('agents-container').innerHTML = 
                    '<div class="loading">ì—ì´ì „íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
            }
        }

        function renderAgents(agents) {
            const container = document.getElementById('agents-container');
            container.innerHTML = agents.map(agent => `
                <div class="agent-card ${agent.isActive ? 'active' : 'inactive'}" id="agent-${agent.agentId}">
                    <div class="agent-header">
                        <div class="agent-name">${agent.nickname}</div>
                        <div class="agent-status">
                            <div class="status-indicator ${agent.isActive ? 'active' : ''}"></div>
                            <div class="toggle-switch ${agent.isActive ? 'active' : ''}" 
                                 onclick="toggleAgent('${agent.agentId}', ${!agent.isActive})"></div>
                        </div>
                    </div>
                    <div class="agent-stats">
                        <div class="agent-stat">
                            <div class="agent-stat-value">${agent.stats24h.posts}</div>
                            <div class="agent-stat-label">ê²Œì‹œë¬¼</div>
                        </div>
                        <div class="agent-stat">
                            <div class="agent-stat-value">${agent.stats24h.replies}</div>
                            <div class="agent-stat-label">ëŒ“ê¸€</div>
                        </div>
                        <div class="agent-stat">
                            <div class="agent-stat-value">${agent.stats24h.reactions}</div>
                            <div class="agent-stat-label">ë°˜ì‘</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                        ë§ˆì§€ë§‰ í™œë™: ${agent.lastActivity ? new Date(agent.lastActivity).toLocaleString('ko-KR') : 'ì—†ìŒ'}
                    </div>
                </div>
            `).join('');
            
            updateStats(agents);
        }

        async function toggleAgent(agentId, activate) {
            try {
                await fetchJSON(`${API_BASE}/agents/${agentId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ active: activate })
                });
                await loadAgents();
                addLog(`${agentId} ì—ì´ì „íŠ¸ê°€ ${activate ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤`);
            } catch (error) {
                alert('ì—ì´ì „íŠ¸ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
            }
        }

        async function emergencyStop() {
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  ì—ì´ì „íŠ¸ë¥¼ ì¤‘ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                await fetchJSON(`${API_BASE}/emergency-stop`, { method: 'POST' });
                await loadAgents();
                addLog('ğŸ›‘ ê¸´ê¸‰ ì •ì§€ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤');
            } catch (error) {
                alert('ê¸´ê¸‰ ì •ì§€ ì‹¤íŒ¨');
            }
        }

        async function activateAll() {
            try {
                await fetchJSON(`${API_BASE}/agents/activate-all`, { method: 'POST' });
                await loadAgents();
                addLog('ëª¨ë“  ì—ì´ì „íŠ¸ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
            } catch (error) {
                alert('ì „ì²´ í™œì„±í™” ì‹¤íŒ¨');
            }
        }

        async function deactivateAll() {
            try {
                await fetchJSON(`${API_BASE}/agents/deactivate-all`, { method: 'POST' });
                await loadAgents();
                addLog('ëª¨ë“  ì—ì´ì „íŠ¸ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
            } catch (error) {
                alert('ì „ì²´ ë¹„í™œì„±í™” ì‹¤íŒ¨');
            }
        }

        function updateStats(agents) {
            const activeAgents = agents.filter(a => a.isActive).length;
            document.getElementById('active-agents').textContent = activeAgents;
            document.getElementById('total-agents').textContent = agents.length;
            
            const totalStats = agents.reduce((acc, agent) => ({
                posts: acc.posts + agent.stats24h.posts,
                replies: acc.replies + agent.stats24h.replies,
                reactions: acc.reactions + agent.stats24h.reactions
            }), { posts: 0, replies: 0, reactions: 0 });
            
            document.getElementById('total-posts').textContent = totalStats.posts;
            document.getElementById('total-replies').textContent = totalStats.replies;
            document.getElementById('total-reactions').textContent = totalStats.reactions;
        }

        function addLog(message) {
            const timestamp = new Date().toLocaleString('ko-KR');
            activityLogs.unshift({ message, timestamp });
            if (activityLogs.length > 50) activityLogs.pop();
            renderLogs();
        }

        function renderLogs() {
            const container = document.getElementById('activity-log-content');
            container.innerHTML = activityLogs.map(log => `
                <div class="log-entry">
                    <div class="log-time">${log.timestamp}</div>
                    <div>${log.message}</div>
                </div>
            `).join('');
        }

        function clearLogs() {
            activityLogs = [];
            renderLogs();
            addLog('ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        async function refreshStats() {
            await loadAgents();
            addLog('í†µê³„ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        async function checkSystemStatus() {
            try {
                const status = await fetchJSON(`${API_BASE}/system/status`);
                document.getElementById('scheduler-status').textContent = status.scheduler.isRunning ? 'ì‹¤í–‰ì¤‘' : 'ì¤‘ì§€ë¨';
                document.getElementById('uptime').textContent = formatUptime(status.scheduler.uptime);
                document.getElementById('api-status').textContent = status.apiStatus ? 'ì •ìƒ' : 'ì˜¤ë¥˜';
                document.getElementById('filter-status').textContent = status.contentFilter ? 'í™œì„±' : 'ë¹„í™œì„±';
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
            }
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}ì‹œê°„ ${minutes}ë¶„`;
        }

        // WebSocket for real-time updates
        function connectWebSocket() {
            const ws = new WebSocket(`ws://${window.location.host}/ws`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                switch(data.type) {
                    case 'contentGenerated':
                        addLog(`ğŸ“ ${data.payload.nickname}ë‹˜ì´ ìƒˆ ê²Œì‹œë¬¼ì„ ì‘ì„±í–ˆìŠµë‹ˆë‹¤`);
                        break;
                    case 'replyGenerated':
                        addLog(`ğŸ’¬ ${data.payload.nickname}ë‹˜ì´ ëŒ“ê¸€ì„ ì‘ì„±í–ˆìŠµë‹ˆë‹¤`);
                        break;
                    case 'reactionGenerated':
                        addLog(`${data.payload.reaction} ${data.payload.nickname}ë‹˜ì´ ë°˜ì‘í–ˆìŠµë‹ˆë‹¤`);
                        break;
                    case 'agentStatusChanged':
                        addLog(`ğŸ”„ ${data.payload.agentId} ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`);
                        loadAgents();
                        break;
                }
            };
            
            ws.onerror = () => {
                console.error('WebSocket ì—°ê²° ì˜¤ë¥˜');
            };
            
            ws.onclose = () => {
                setTimeout(connectWebSocket, 5000);
            };
        }

        // Initialize
        window.onload = async () => {
            const token = prompt('ê´€ë¦¬ì í† í°ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (token) {
                localStorage.setItem('adminToken', token);
            }
            
            await loadAgents();
            await checkSystemStatus();
            connectWebSocket();
            
            setInterval(checkSystemStatus, 30000);
            
            addLog('ëŒ€ì‹œë³´ë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤');
        };
    </script>
</body>
</html>