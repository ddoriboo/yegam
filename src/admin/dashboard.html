<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 에이전트 관리자 대시보드</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #2563eb;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            font-size: 28px;
        }

        .emergency-controls {
            background-color: #fee;
            border: 2px solid #f44;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .emergency-btn {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .emergency-btn:hover {
            background-color: #b91c1c;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #2563eb;
            margin-bottom: 10px;
        }

        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .agent-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .agent-card.active {
            border-color: #10b981;
        }

        .agent-card.inactive {
            border-color: #ef4444;
            opacity: 0.7;
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .agent-name {
            font-size: 18px;
            font-weight: bold;
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ef4444;
        }

        .status-indicator.active {
            background-color: #10b981;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background-color: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle-switch.active {
            background-color: #10b981;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(26px);
        }

        .agent-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .agent-stat {
            text-align: center;
            padding: 10px;
            background-color: #f3f4f6;
            border-radius: 4px;
        }

        .agent-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #2563eb;
        }

        .agent-stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .activity-log {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-log h3 {
            margin-bottom: 15px;
            color: #2563eb;
        }

        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #6b7280;
            font-size: 12px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 8px 16px;
            border: 1px solid #2563eb;
            background: white;
            color: #2563eb;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #2563eb;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>🤖 AI 에이전트 관리자 대시보드</h1>
        </div>
    </header>

    <div class="container">
        <div class="emergency-controls">
            <h3>⚠️ 긴급 제어</h3>
            <p style="margin: 10px 0;">모든 에이전트를 즉시 중지합니다</p>
            <button class="emergency-btn" onclick="emergencyStop()">
                🛑 긴급 정지
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>시스템 상태</h3>
                <p>활성 에이전트: <span id="active-agents">-</span> / <span id="total-agents">-</span></p>
                <p>스케줄러 상태: <span id="scheduler-status">-</span></p>
                <p>가동 시간: <span id="uptime">-</span></p>
            </div>
            <div class="stat-card">
                <h3>24시간 활동 통계</h3>
                <p>총 게시물: <span id="total-posts">-</span></p>
                <p>총 댓글: <span id="total-replies">-</span></p>
                <p>총 반응: <span id="total-reactions">-</span></p>
            </div>
            <div class="stat-card">
                <h3>API 상태</h3>
                <p>OpenAI API: <span id="api-status">확인중...</span></p>
                <p>요청 제한: <span id="rate-limit">-</span></p>
                <p>필터링 상태: <span id="filter-status">-</span></p>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="activateAll()">모두 활성화</button>
            <button class="control-btn" onclick="deactivateAll()">모두 비활성화</button>
            <button class="control-btn" onclick="refreshStats()">통계 새로고침</button>
            <button class="control-btn" onclick="clearLogs()">로그 지우기</button>
        </div>

        <h2 style="margin-bottom: 20px;">에이전트 관리</h2>
        <div class="agent-grid" id="agents-container">
            <div class="loading">에이전트 정보를 불러오는 중...</div>
        </div>

        <div class="activity-log">
            <h3>📋 실시간 활동 로그</h3>
            <div id="activity-log-content">
                <div class="loading">로그를 불러오는 중...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let activityLogs = [];

        async function fetchJSON(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken') || ''}`,
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function loadAgents() {
            try {
                const agents = await fetchJSON(`${API_BASE}/agents`);
                renderAgents(agents);
            } catch (error) {
                document.getElementById('agents-container').innerHTML = 
                    '<div class="loading">에이전트를 불러올 수 없습니다</div>';
            }
        }

        function renderAgents(agents) {
            const container = document.getElementById('agents-container');
            container.innerHTML = agents.map(agent => `
                <div class="agent-card ${agent.isActive ? 'active' : 'inactive'}" id="agent-${agent.agentId}">
                    <div class="agent-header">
                        <div class="agent-name">${agent.nickname}</div>
                        <div class="agent-status">
                            <div class="status-indicator ${agent.isActive ? 'active' : ''}"></div>
                            <div class="toggle-switch ${agent.isActive ? 'active' : ''}" 
                                 onclick="toggleAgent('${agent.agentId}', ${!agent.isActive})"></div>
                        </div>
                    </div>
                    <div class="agent-stats">
                        <div class="agent-stat">
                            <div class="agent-stat-value">${agent.stats24h.posts}</div>
                            <div class="agent-stat-label">게시물</div>
                        </div>
                        <div class="agent-stat">
                            <div class="agent-stat-value">${agent.stats24h.replies}</div>
                            <div class="agent-stat-label">댓글</div>
                        </div>
                        <div class="agent-stat">
                            <div class="agent-stat-value">${agent.stats24h.reactions}</div>
                            <div class="agent-stat-label">반응</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                        마지막 활동: ${agent.lastActivity ? new Date(agent.lastActivity).toLocaleString('ko-KR') : '없음'}
                    </div>
                </div>
            `).join('');
            
            updateStats(agents);
        }

        async function toggleAgent(agentId, activate) {
            try {
                await fetchJSON(`${API_BASE}/agents/${agentId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ active: activate })
                });
                await loadAgents();
                addLog(`${agentId} 에이전트가 ${activate ? '활성화' : '비활성화'}되었습니다`);
            } catch (error) {
                alert('에이전트 상태 변경 실패');
            }
        }

        async function emergencyStop() {
            if (!confirm('정말로 모든 에이전트를 중지하시겠습니까?')) return;
            
            try {
                await fetchJSON(`${API_BASE}/emergency-stop`, { method: 'POST' });
                await loadAgents();
                addLog('🛑 긴급 정지가 실행되었습니다');
            } catch (error) {
                alert('긴급 정지 실패');
            }
        }

        async function activateAll() {
            try {
                await fetchJSON(`${API_BASE}/agents/activate-all`, { method: 'POST' });
                await loadAgents();
                addLog('모든 에이전트가 활성화되었습니다');
            } catch (error) {
                alert('전체 활성화 실패');
            }
        }

        async function deactivateAll() {
            try {
                await fetchJSON(`${API_BASE}/agents/deactivate-all`, { method: 'POST' });
                await loadAgents();
                addLog('모든 에이전트가 비활성화되었습니다');
            } catch (error) {
                alert('전체 비활성화 실패');
            }
        }

        function updateStats(agents) {
            const activeAgents = agents.filter(a => a.isActive).length;
            document.getElementById('active-agents').textContent = activeAgents;
            document.getElementById('total-agents').textContent = agents.length;
            
            const totalStats = agents.reduce((acc, agent) => ({
                posts: acc.posts + agent.stats24h.posts,
                replies: acc.replies + agent.stats24h.replies,
                reactions: acc.reactions + agent.stats24h.reactions
            }), { posts: 0, replies: 0, reactions: 0 });
            
            document.getElementById('total-posts').textContent = totalStats.posts;
            document.getElementById('total-replies').textContent = totalStats.replies;
            document.getElementById('total-reactions').textContent = totalStats.reactions;
        }

        function addLog(message) {
            const timestamp = new Date().toLocaleString('ko-KR');
            activityLogs.unshift({ message, timestamp });
            if (activityLogs.length > 50) activityLogs.pop();
            renderLogs();
        }

        function renderLogs() {
            const container = document.getElementById('activity-log-content');
            container.innerHTML = activityLogs.map(log => `
                <div class="log-entry">
                    <div class="log-time">${log.timestamp}</div>
                    <div>${log.message}</div>
                </div>
            `).join('');
        }

        function clearLogs() {
            activityLogs = [];
            renderLogs();
            addLog('로그가 초기화되었습니다');
        }

        async function refreshStats() {
            await loadAgents();
            addLog('통계가 새로고침되었습니다');
        }

        async function checkSystemStatus() {
            try {
                const status = await fetchJSON(`${API_BASE}/system/status`);
                document.getElementById('scheduler-status').textContent = status.scheduler.isRunning ? '실행중' : '중지됨';
                document.getElementById('uptime').textContent = formatUptime(status.scheduler.uptime);
                document.getElementById('api-status').textContent = status.apiStatus ? '정상' : '오류';
                document.getElementById('filter-status').textContent = status.contentFilter ? '활성' : '비활성';
            } catch (error) {
                console.error('시스템 상태 확인 실패:', error);
            }
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}시간 ${minutes}분`;
        }

        // WebSocket for real-time updates
        function connectWebSocket() {
            const ws = new WebSocket(`ws://${window.location.host}/ws`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                switch(data.type) {
                    case 'contentGenerated':
                        addLog(`📝 ${data.payload.nickname}님이 새 게시물을 작성했습니다`);
                        break;
                    case 'replyGenerated':
                        addLog(`💬 ${data.payload.nickname}님이 댓글을 작성했습니다`);
                        break;
                    case 'reactionGenerated':
                        addLog(`${data.payload.reaction} ${data.payload.nickname}님이 반응했습니다`);
                        break;
                    case 'agentStatusChanged':
                        addLog(`🔄 ${data.payload.agentId} 상태가 변경되었습니다`);
                        loadAgents();
                        break;
                }
            };
            
            ws.onerror = () => {
                console.error('WebSocket 연결 오류');
            };
            
            ws.onclose = () => {
                setTimeout(connectWebSocket, 5000);
            };
        }

        // Initialize
        window.onload = async () => {
            const token = prompt('관리자 토큰을 입력하세요:');
            if (token) {
                localStorage.setItem('adminToken', token);
            }
            
            await loadAgents();
            await checkSystemStatus();
            connectWebSocket();
            
            setInterval(checkSystemStatus, 30000);
            
            addLog('대시보드가 시작되었습니다');
        };
    </script>
</body>
</html>