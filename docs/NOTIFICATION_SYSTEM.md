# 예겜 알림 시스템 완전 가이드

## 📋 개요

예겜 플랫폼의 모든 알림 타입, 트리거 조건, 발송 문구를 정리한 문서입니다.

---

## 🔔 알림 타입 및 상세 정보

### 1. 이슈 신청 관련 알림

#### 1.1 이슈 신청 승인 (`issue_request_approved`)
- **트리거**: 관리자가 이슈 신청을 승인할 때
- **발송 위치**: `routes/issue-requests.js:270`
- **아이콘**: ✅ 녹색 체크 서클
- **제목**: "이슈 신청이 승인되었습니다"
- **메시지**: `신청하신 이슈 "{이슈제목}"가 승인되어 예측 시장에 등록되었습니다. 지금 바로 베팅에 참여해보세요!`
- **추가 혜택**: 1000 GAM 지급

#### 1.2 이슈 신청 거부 (`issue_request_rejected`)
- **트리거**: 관리자가 이슈 신청을 거부할 때
- **발송 위치**: `routes/issue-requests.js:338`
- **아이콘**: ❌ 빨간색 X 서클
- **제목**: "이슈 신청이 거부되었습니다"
- **메시지**: `신청하신 이슈 "{이슈제목}"가 거부되었습니다. 사유: {거부사유}`

---

### 2. 이슈 마감 관련 알림

#### 2.1 이슈 마감 알림 (`issue_closed`)
- **트리거**: 스케줄러가 이슈를 자동 마감할 때
- **발송 위치**: `services/scheduler.js:86`
- **아이콘**: 🕒 파란색 시계
- **제목**: "이슈가 마감되었습니다"
- **메시지**: `"{이슈제목}" 이슈가 마감되었습니다. 회원님의 선택: {찬성/반대} ({베팅금액} GAM)\n결과 발표를 기다려 주세요.`

---

### 3. 베팅 결과 관련 알림

#### 3.1 베팅 승리 (`betting_win`)
- **트리거**: 관리자가 이슈 결과를 설정할 때 (승리한 베터들)
- **발송 위치**: `routes/admin.js:405`
- **아이콘**: 🏆 노란색 트로피
- **제목**: "🎉 베팅에서 승리했습니다!"
- **메시지**: `"{이슈제목}" 이슈에서 승리했습니다! 베팅 금액: {베팅금액} GAM, 수익: +{순이익} GAM`
- **추가 혜택**: 보상 GAM 지급

#### 3.2 베팅 패배 (`betting_loss`)
- **트리거**: 관리자가 이슈 결과를 설정할 때 (패배한 베터들)
- **발송 위치**: `routes/admin.js:422`
- **아이콘**: ➖ 회색 마이너스 서클
- **제목**: "😔 베팅 결과 안내"
- **메시지**: `"{이슈제목}" 이슈에서 아쉽게 패배했습니다. 베팅 금액: {베팅금액} GAM\n\n결정 사유: {사유}`

#### 3.3 베팅 무승부 (`betting_draw`)
- **트리거**: 관리자가 이슈 결과를 '무승부'로 설정할 때
- **발송 위치**: `routes/admin.js:468`
- **아이콘**: ↩️ 파란색 회전 화살표
- **제목**: "↩️ 베팅 무승부 - 환불 완료"
- **메시지**: `"{이슈제목}" 이슈가 무승부로 종료되어 베팅 금액 {베팅금액} GAM이 전액 환불되었습니다.`
- **추가 혜택**: 베팅 금액 전액 환불

#### 3.4 베팅 취소 (`betting_cancelled`)
- **트리거**: 관리자가 이슈 결과를 '취소'로 설정할 때
- **발송 위치**: `routes/admin.js:468`
- **아이콘**: ❌ 빨간색 X 박스
- **제목**: "❌ 베팅 취소 - 환불 완료"
- **메시지**: `"{이슈제목}" 이슈가 취소되어 베팅 금액 {베팅금액} GAM이 전액 환불되었습니다.\n\n취소 사유: {사유}`
- **추가 혜택**: 베팅 금액 전액 환불

---

### 4. 보상 관련 알림

#### 4.1 GAM 포인트 지급 (`gam_reward`)
- **트리거**: 다양한 상황에서 GAM 지급 시
- **발송 위치**: 이슈 신청 승인, 기타 보상 지급 시
- **아이콘**: 🪙 노란색 코인
- **제목**: "🪙 GAM 포인트가 지급되었습니다"
- **메시지**: `{금액} GAM이 지급되었습니다. 사유: {지급사유}`

#### 4.2 보상 지급 알림 (`reward_distributed`)
- **트리거**: 베팅 승리 시 보상 지급
- **발송 위치**: NotificationService에 구현됨
- **아이콘**: 🎁 보라색 선물
- **제목**: "💰 보상이 지급되었습니다"
- **메시지**: `"{이슈제목}" 베팅 승리 보상이 지급되었습니다!\n베팅액: {베팅금액} GAM\n총 보상: {총보상} GAM\n순이익: +{순이익} GAM`

---

### 5. 시스템 알림

#### 5.1 프리미엄 기능 (`premium_feature`)
- **트리거**: 프리미엄 기능 활성화 시
- **발송 위치**: NotificationService에 구현됨
- **아이콘**: ⭐ 주황색 별
- **제목**: "✨ {기능명} 기능이 활성화되었습니다"
- **메시지**: `{기능설명}`

#### 5.2 시스템 공지 (`system_announcement`)
- **트리거**: 개별 사용자 대상 공지 발송 시
- **발송 위치**: NotificationService에 구현됨
- **아이콘**: 📢 파란색 메가폰
- **제목**: "📢 {공지제목}"
- **메시지**: `{공지내용}`

#### 5.3 전체 공지 (`system_broadcast`)
- **트리거**: 전체 사용자 대상 공지 발송 시
- **발송 위치**: NotificationService에 구현됨
- **아이콘**: 📻 파란색 라디오
- **제목**: "📢 {공지제목}"
- **메시지**: `{공지내용}`

---

## 🔄 알림 처리 플로우

### 이슈 라이프사이클과 알림

```
이슈 신청 → 관리자 검토 → [승인/거부] 알림
                     ↓
             이슈 활성화 및 베팅 가능
                     ↓
             스케줄러 자동 마감 → 마감 알림
                     ↓
             관리자 결과 설정 → [승리/패배/무승부/취소] 알림
```

### 베팅 결과 처리 플로우

```
관리자 결과 설정
       ↓
   베팅 조회
       ↓
승리자 계산 → 보상 지급 → 승리 알림
       ↓
패배자 처리 → 패배 알림
       ↓
무승부/취소 → 환불 처리 → 환불 알림
```

---

## ⚙️ 기술적 구현

### 알림 생성
- **서비스**: `services/notificationService.js`
- **데이터베이스**: `notifications` 테이블
- **필드**: `user_id`, `type`, `title`, `message`, `related_id`, `related_type`, `is_read`, `created_at`

### 알림 표시
- **헤더**: `js/ui/header.js` - 드롭다운 최신 10개
- **마이페이지**: `js/pages/mypage.js` - 페이지네이션으로 전체 목록

### 알림 아이콘
- **위치**: `getNotificationIcon()` 함수
- **라이브러리**: Lucide Icons
- **색상**: 알림 타입별 구분 (성공=녹색, 실패=빨간색, 정보=파란색 등)

---

## 🧪 테스트 방법

### 개발 환경 테스트
- **엔드포인트**: `POST /api/test-notifications/create`
- **지원 타입**: 모든 알림 타입 테스트 가능
- **사용법**: 
  ```bash
  curl -X POST http://localhost:3000/api/test-notifications/create \
    -H "Authorization: Bearer {토큰}" \
    -H "Content-Type: application/json" \
    -d '{"type": "betting_win"}'
  ```

### 전체 공지 테스트
- **엔드포인트**: `POST /api/test-notifications/broadcast`
- **사용법**:
  ```bash
  curl -X POST http://localhost:3000/api/test-notifications/broadcast \
    -H "Authorization: Bearer {토큰}" \
    -H "Content-Type: application/json" \
    -d '{"title": "테스트 공지", "message": "테스트 메시지입니다"}'
  ```

---

## 📊 알림 상태 모니터링

### 알림 통계 API
- **엔드포인트**: `GET /api/test-notifications/status`
- **제공 정보**:
  - 전체 알림 수
  - 읽지 않은 알림 수
  - 알림 타입별 통계
  - 최근 알림 5개

---

## ⚠️ 주의사항

1. **알림 실패 처리**: 알림 생성 실패가 비즈니스 로직을 중단하지 않도록 try-catch 처리
2. **성능 고려**: 대량 알림 생성 시 `createBulkNotifications()` 사용
3. **데이터 일관성**: 트랜잭션 내에서 알림 생성하여 데이터 무결성 보장
4. **환경별 제한**: 프로덕션에서는 테스트 엔드포인트 비활성화

---

## 🔮 향후 개선사항

1. **실시간 푸시**: WebSocket을 통한 실시간 알림
2. **이메일 알림**: 중요 알림의 이메일 발송
3. **알림 설정**: 사용자별 알림 수신 설정
4. **템플릿 시스템**: 알림 메시지 템플릿화
5. **다국어 지원**: 알림 메시지 다국어 처리

---

*최종 업데이트: 2025-06-21*
*작성자: Claude Code Assistant*